<!DOCTYPE html>
<html lang="zh-CN">
<style>
    /* å¼•å…¥ç°ä»£å­—ä½“ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    :root {
        --brand-black: #1a1a1a;
        --brand-accent: #2c3e50;
        --bg-color: #f8fafc;
        --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        --highlight-gold: #fffbeb; 
        --error-red: #ef4444;
    }

    body { 
        font-family: 'Inter', system-ui, -apple-system, sans-serif; 
        background: var(--bg-color); 
        padding: 60px 20px; 
        color: var(--brand-black);
        line-height: 1.5;
    }

    .form-container { 
        max-width: 800px; 
        margin: auto; 
        background: #ffffff; /* å·²ä¿®æ­£ï¼šåŸä»£ç ä¸­ ï¼ƒ ç¬¦å·å¯¼è‡´å¤±æ•ˆï¼Œæ­¤å¤„è®¾ä¸ºçº¯ç™½ä»¥ä¿æŒé«˜çº§æ„Ÿ */
        padding: 50px; 
        border-radius: 24px; 
        box-shadow: var(--card-shadow); 
    }

    h2 { 
        text-align: center; 
        font-weight: 700; 
        letter-spacing: -0.025em; 
        margin-bottom: 40px; 
        color: var(--brand-black);
        font-size: 28px;
        text-transform: uppercase;
    }

    .group { 
        margin-bottom: 35px; 
        padding-bottom: 20px;
        border-bottom: 1px solid #f1f5f9;
    }
    
    /* --- é¢æ–™æ¿å—æ ·å¼ --- */
    .fabric-priority-group {
        background: #fff;
        border: 2px solid #1a1a1a;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        position: relative;
        transition: var(--transition);
    }
    .fabric-title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 6px;
        text-transform: uppercase;
        font-weight: 700;
    }
    .status-required { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
    .status-ok { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }

    .fabric-category-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    .category-card {
        border: 1.5px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px 8px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        background: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .category-card:hover { border-color: #94a3b8; }
    .category-card input { position: absolute; opacity: 0; }
    .category-card .icon { font-size: 20px; margin-bottom: 5px; }
    .category-card span { font-size: 11px; font-weight: 700; color: #475569; line-height: 1.2; }
    
    .category-card input:checked + .cat-ui {
        border: 2px solid var(--brand-black);
        position: absolute; top: -1px; left: -1px; right: -1px; bottom: -1px;
        border-radius: 12px;
        background: rgba(0,0,0,0.02);
    }
    .category-card input:checked ~ span { color: var(--brand-black); }

    /* å…¶ä»–é€šç”¨æ ·å¼ */
    .group:last-of-type { border-bottom: none; }
    label { display: block; margin-bottom: 12px; font-size: 12px; text-transform: uppercase; color: #64748b; font-weight: 700; letter-spacing: 0.1em; }
    
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea { 
        width: 100%; padding: 14px 16px; border: 1.5px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; background: #fff; font-size: 15px; transition: var(--transition);
    }
    input:focus, select:focus { border-color: var(--brand-black); outline: none; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }
    
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .row div { flex: 1; }
    
    .mount-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .mount-card { border: 1.5px solid #e2e8f0; border-radius: 16px; padding: 20px; cursor: pointer; transition: var(--transition); position: relative; background: #fff; }
    .mount-card:hover { border-color: #cbd5e1; transform: translateY(-2px); }
    .mount-card input { position: absolute; opacity: 0; }
    .mount-card input:checked ~ .card-ui { border: 2px solid var(--brand-black); position: absolute; top: -1px; left: -1px; right: -1px; bottom: -1px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    .mount-img { width: 100%; border-radius: 8px; margin-bottom: 12px; cursor: zoom-in; transition: transform 0.3s ease; }
    .mount-img:hover { transform: scale(1.05); }
    
    .options-scroll-box { margin-top: 15px; padding: 20px; background: #f8fafc; border: 1.5px solid #f1f5f9; border-radius: 16px; max-height: 420px; overflow-y: auto; position: relative; }
    .options-scroll-box::-webkit-scrollbar { width: 5px; }
    .options-scroll-box::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    
    .grid-item { border: 1.5px solid #e2e8f0; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; transition: var(--transition); position: relative; background: #fff; overflow: hidden; }
    .grid-item:hover { border-color: #94a3b8; transform: translateY(-2px); }
    
    .grid-item img { width: 100%; height: 110px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; cursor: zoom-in; transition: transform 0.3s ease; }
    .grid-item img:hover { transform: scale(1.05); }
    .grid-item span { font-size: 12px; color: #1e293b; font-weight: 600; display: block; padding-top: 5px; }
    .grid-item input { position: absolute; opacity: 0; }
    
    /* é€‰ä¸­æ—¶çš„é»‘è‰²è¾¹æ¡†é€»è¾‘ */
    .grid-item input:checked + .item-ui { 
        border: 2.5px solid var(--brand-black); 
        position: absolute; top: -1px; left: -1px; right: -1px; bottom: -1px; 
        border-radius: 12px; background: rgba(0,0,0,0.02); 
    }

    /* å·²é€‰æ ·å¼æ±‡æ€»åŒº */
    .selected-summary { margin-top: 0; padding: 15px; background: #fff; border: 1.5px dashed #e2e8f0; border-radius: 12px; font-size: 13px; }
    .summary-tag { display: inline-block; background: var(--brand-black); color: #fff; padding: 4px 12px; margin: 3px; border-radius: 20px; font-weight: 500; }
    
    /* æ”¾å¤§é•œ Modal */
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999999; justify-content: center; align-items: center; backdrop-filter: blur(8px); cursor: zoom-out; }
    #modal-img { max-width: 90%; max-height: 85%; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 4px solid #fff; object-fit: contain; }
    
    button[type="submit"] { width: 100%; padding: 18px; background: var(--brand-black); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 30px; transition: var(--transition); letter-spacing: 1px; }
    button[type="submit"]:hover { background: #333; transform: scale(1.02); }
    
    .btn-clear { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; transition: var(--transition); border: none; cursor: pointer; }
    .btn-clear:hover { background: #e2e8f0; color: #0f172a; }
    
    .must-pick-note { color: #ef4444; font-weight: 500; font-size: 12px; }
    .compact-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .footer-note { font-size: 13px; color: #94a3b8; text-align: center; margin-top: 30px; font-weight: 500; }

    /* å¼ºåˆ¶é™åˆ¶ç‰¹å®šæ¿å—çš„å›¾ç‰‡é«˜åº¦ */
    #valanceGrid img, #rodGrid img {
        width: 100%;
        height: 120px;       /* å›ºå®šé«˜åº¦ */
        object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
        margin-bottom: 5px;
    }
    
    /* é…ä»¶é€‰ä¸­æ—¶çš„é»‘è‰²è¾¹æ¡†é€»è¾‘ */
    #valanceGrid input:checked + .item-ui,
    #rodGrid input:checked + .item-ui {
        position: absolute;
        top: -1.5px; left: -1.5px; right: -1.5px; bottom: -1.5px;
        border: 2.5px solid #1a1a1a;
        border-radius: 12px;
        z-index: 5;
        pointer-events: none;
    }

    /* åŠ¨ç”»ä¸çŠ¶æ€æç¤º */
    @keyframes highlightUpdate {
        0% { background-color: transparent; }
        50% { background-color: rgba(255, 235, 59, 0.3); }
        100% { background-color: transparent; }
    }

   .section-updated {
    animation: highlightUpdate 0.8s ease-in-out;
}
@keyframes highlightUpdate {
    0% { background-color: rgba(255, 77, 79, 0.1); }
    50% { background-color: rgba(255, 77, 79, 0.3); }
    100% { background-color: transparent; }
}

    .update-badge::after {
        content: "Updated";
        font-size: 10px;
        background: #ff4d4f;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        vertical-align: middle;
    }
</style>

<div class="form-container">
    <h2>AprilSmart Custom Order</h2>
    <form action="https://formspree.io/f/xdanvzbn" method="POST" onsubmit="return validateForm()">
        
        <div class="group">
            <label>Full Name / å§“å</label>
            <input type="text" name="Customer Name" placeholder="Enter your full name" required>
        </div>

        <div class="group">
            <label>Email / é‚®ç®±</label>
            <input type="email" name="_replyto" placeholder="yourname@email.com" required>
        </div>

        <div class="group">
            <label>Contract Number / è”ç³»ç”µè¯</label>
            <input type="tel" name="Phone_Number" placeholder="+1 (000) 000-0000" required>
        </div>

        <div class="row">
            <div>
                <label>Width / å®½åº¦ (Whole)</label>
                <input type="number" name="Width_Base" placeholder="Inches" required>
            </div>
            <div>
                <label>Height / é«˜åº¦ (Whole)</label>
                <input type="number" name="Height_Base" placeholder="Inches" required>
            </div>
        </div>

        <div class="row group">
            <div>
                <label>Width: Fractional</label>
                <select name="Width_Fraction">
                    <option value="0/0">0/0</option>
                    <option value="1/8">1/8"</option>
                    <option value="1/4">1/4"</option>
                    <option value="3/8">3/8"</option>
                    <option value="1/2">1/2"</option>
                    <option value="5/8">5/8"</option>
                    <option value="3/4">3/4"</option>
                    <option value="7/8">7/8"</option>
                </select>
            </div>
            <div>
                <label>Height: Fractional</label>
                <select name="Height_Fraction">
                    <option value="0/0">0/0</option>
                    <option value="1/8">1/8"</option>
                    <option value="1/4">1/4"</option>
                    <option value="3/8">3/8"</option>
                    <option value="1/2">1/2"</option>
                    <option value="5/8">5/8"</option>
                    <option value="3/4">3/4"</option>
                    <option value="7/8">7/8"</option>
                </select>
            </div>
        </div>

        <div class="group">
            <label>Mount Type / å®‰è£…æ–¹å¼ (Click to Zoom)</label>
            <div class="mount-options">
                <label class="mount-card">
                    <input type="radio" name="Mount_Type" value="Inside Mount" checked>
                    <div class="card-ui"></div>
                    <div class="card-content">
                        <img src="image/inside.png" class="mount-img" onclick="zoomImg(this.src)" alt="Inside">
                        <div style="font-size:11px; color:#475569;"><b>INSIDE MOUNT</b><br>W=Order W, H=Order H<br>Depthâ‰¥2"</div>
                    </div>
                </label>
                <label class="mount-card">
                    <input type="radio" name="Mount_Type" value="Outside Mount">
                    <div class="card-ui"></div>
                    <div class="card-content">
                        <img src="image/outside.png" class="mount-img" onclick="zoomImg(this.src)" alt="Outside">
                        <div style="font-size:11px; color:#475569;"><b>OUTSIDE MOUNT</b><br>W=Win+6", H=Win+6"<br>*Best for Blackout</div>
                    </div>
                </label>
            </div>
        </div>

        <div class="group fabric-priority-group" id="fabricSection">
    <div class="fabric-title-bar">
        <label style="margin-bottom:0">Step 1: Choose Fabric Category / é¢æ–™å¤§ç±»</label>
        <span id="fabricStatus" class="status-badge status-required">Required / å¿…é€‰</span>
    </div>
    
    <div class="fabric-category-selector">
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="blackout" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸŒ‘</span>
            <span>100% Blackout</span>
        </label>
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="filtering" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸŒ—</span>
            <span>Light Filtering</span>
        </label>
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="zebra" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸ¦“</span>
            <span>Zebra Shades</span>
        </label>
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="cellular" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸ</span>
            <span>Cellular Shades</span>
        </label>
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="roman" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸ“œ</span>
            <span>Roman Shades</span>
        </label>
        <label class="category-card">
            <input type="radio" name="Fabric_Category" value="woven" onchange="updateFabricList()">
            <div class="cat-ui"></div>
            <span class="icon">ğŸªµ</span>
            <span>Woven Wood</span>
        </label>
    </div>

    <div id="fabricDetailSection" class="options-scroll-box" style="margin-top:20px; border-top:1px dashed #eee; padding-top:15px; display:none;">
        <div class="fabric-header" style="margin-bottom:10px;">
            <label style="margin-bottom:0">Step 2: Select Styles / é€‰æ‹©å…·ä½“èŠ±è‰²</label>
        </div>
        <div id="fabricGrid" class="selection-grid"></div>
    </div>

    <div id="persistentSummary" style="display:none; margin-bottom:15px; border-top:1px solid #f1f5f9; padding-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label style="margin-bottom:0; font-size:14px; font-weight:600; color:#475569;">Selected Styles / å·²é€‰æ ·å¼</label>
            <button type="button" class="btn-clear" onclick="clearFabrics()" style="color:#ef4444; background:none; border:1px solid #fca5a5; padding:2px 8px; border-radius:4px; cursor:pointer; font-size:12px;">Clear All</button>
        </div>
        <div id="selectedSummary" class="selected-summary" style="margin-top:0; background:#f8fafc; padding:10px; border-radius:6px; min-height:30px;">
            Selected: (None)
        </div>
    </div>
</div> <hr style="margin:25px 0; border:0; border-top:1px solid #e2e8f0;">

<div class="group" id="valanceGroup">
    <label style="display:flex; align-items:center; justify-content:space-between;">
        Valance Options / ç½©å£³é€‰æ‹© 
        <span id="valanceStatus" class="status-badge status-required">Required / å¿…é€‰</span>
    </label>
    <div class="options-scroll-box">
        <div id="valanceGrid" class="selection-grid"></div>
    </div>
</div>

<div class="group" id="rodGroup" style="margin-top:20px;">
    <label style="display:flex; align-items:center; justify-content:space-between;">
        Bottom Rod Options / åº•æ†é€‰æ‹© 
        <span id="rodStatus" class="status-badge status-required">Required / å¿…é€‰</span>
    </label>
    <div class="options-scroll-box">
        <div id="rodGrid" class="selection-grid"></div>
    </div>
</div>

        <div class="row group">
            <div style="flex:1;">
                <label>Roll Position</label>
                <div class="compact-selection">
                    <label class="grid-item"><input type="radio" name="Roll_Position" value="Standard Roll" checked><div class="item-ui"></div><img src="image/Standard Roll.png" onclick="zoomImg(this.src)"><span>Standard Roll</span></label>
                    <label class="grid-item"><input type="radio" name="Roll_Position" value="Reverse Roll"><div class="item-ui"></div><img src="image/Reverse Roll.png" onclick="zoomImg(this.src)"><span>Reverse Roll</span></label>
                </div>
            </div>
            <div style="flex:1;">
                <label>Motor Side</label>
                <div class="compact-selection">
                    <label class="grid-item"><input type="radio" name="Motor_Side" value="Motor-Left" checked><div class="item-ui"></div><img src="image/Left side.png" onclick="zoomImg(this.src)"><span>Motor-Left</span></label>
                    <label class="grid-item"><input type="radio" name="Motor_Side" value="Motor-Right"><div class="item-ui"></div><img src="image/Right side.png" onclick="zoomImg(this.src)"><span>Motor-Right</span></label>
                </div>
            </div>
        </div>

        <div class="group">
            <label>Other accessories <span class="must-pick-note">(Pick Charger or Magnetic Cable)</span></label>
            <div class="options-scroll-box">
                <div class="selection-grid" id="accGrid">
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="1-ch remote"><div class="item-ui"></div><img src="image/1-Channel Remote Control.png" onclick="zoomImg(this.src)"><span>1-ch Remote</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="15-ch remote"><div class="item-ui"></div><img src="image/15-Channel Remote Control.png" onclick="zoomImg(this.src)"><span>15-ch Remote</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Charger Block"><div class="item-ui"></div><img src="image/Charger Block.png" onclick="zoomImg(this.src)"><span>Charger Block</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Charger Cable" class="cable-group"><div class="item-ui"></div><img src="image/Charger Cable.png" onclick="zoomImg(this.src)"><span>Charger Cable</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Magnetic Cable" class="cable-group"><div class="item-ui"></div><img src="image/Magnetic Cable.png" onclick="zoomImg(this.src)"><span>Magnetic Cable</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Light Blockers-White"><div class="item-ui"></div><img src="image/Light Blockers-White.png" onclick="zoomImg(this.src)"><span>Blockers-White</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Light Blockers-Black"><div class="item-ui"></div><img src="image/Light Blockers-Black.png" onclick="zoomImg(this.src)"><span>Blockers-Black</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Side Rail-White"><div class="item-ui"></div><img src="image/Side Rail Track-White.png" onclick="zoomImg(this.src)"><span>Rail-White</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Side Rail-Black"><div class="item-ui"></div><img src="image/Side Rail Track-Black.png" onclick="zoomImg(this.src)"><span>Rail-Black</span></label>
                    <label class="grid-item"><input type="checkbox" name="Accessories" value="Solar Panel"><div class="item-ui"></div><img src="image/Solar Panel.png" onclick="zoomImg(this.src)"><span>Solar Panel</span></label>
                </div>
            </div>
        </div>

        <div class="group">
            <label>Additional Notes</label>
            <textarea name="Message" rows="4" placeholder="Share any special instructions here..."></textarea>
        </div>

        <button type="submit">SUBMIT ORDER REQUEST</button>
        <p class="footer-note">AprilSmart Â® Customized Shading Solutions</p>
    </form>
</div>

<div id="modal" onclick="this.style.display='none'">
    <img id="modal-img" src="">
</div>
<body>

<script>
// --- [1] å…¨å±€è®°å¿†ä¸æ•°æ®é…ç½® ---
let selectionsMemory = {}; // è®°å½•æ¯ä¸ªå¤§ç±»çš„é…ä»¶é€‰æ‹©çŠ¶æ€
let globalSelectedFabrics = new Map(); // è®°å½•é€‰ä¸­çš„é¢æ–™åŠå…¶æ‰€å±å¤§ç±»

// --- [2] åŸå§‹æ•°æ®å®šä¹‰ ---
const blackoutFiles = ["Blackout_Baltimore_Anthracite_25", "Blackout_Baltimore_Bronze_26", "Blackout_Baltimore_Flint_27", "Blackout_Bermuda_Basalt_24", "Blackout_Bermuda_Platinum_22", "Blackout_Bermuda_Toffee_23", "Blackout_BouvardiaDark_Grey_17", "Blackout_BouvardiaMedium_Grey_18", "Blackout_Cream_White_06", "Blackout_Linen_Stone_01", "Blackout_Linen_Stone_02", "Blackout_Safari_Cream_04", "Blackout_Safari_Midnight_05", "Blackout_Safari_Stone_07", "Blackout_Safari_White_03", "Blackout_SafariBiscuit_20", "Blackout_SafariSmoke_19", "Blackout_Treebark_Obsidian_28", "Blackout_Treebark_Extra_White_29", "Blackout_Vigor_Cream_08", "Blackout_Vigor_Milky_11", "Blackout_Vigor_RockWhite_21", "Blackout_Vigor_sage_10", "Blackout_Vigor_Wheat_09", "Blackout_Vinyl_Beige_13", "Blackout_Vinyl_Black_14", "Blackout_Vinyl_Grey_16", "Blackout_Vinyl_White_12", "Blackout_Vinyl_WhiteGrey-15"];
const filteringFiles = ["Light_Filtering_5pct_OPENNESS_AVENTUS_BLACK_54", "Light_Filtering_5pct_OPENNESS_AVENTUS_ICE_51", "Light_Filtering_5pct_OPENNESS_AVENTUS_WHITE_GREY_53", "Light_Filtering_5pct_OPENNESS_AVENTUSWHITE_LINEN_52", "Light_Filtering_50pct_SUNSCREEN_BLACK_61", "Light_Filtering_50pct_SUNSCREEN_COCOA_60", "Light_Filtering_50pct_SUNSCREEN_GREY_59", "Light_Filtering_50pct_SUNSCREEN_WHITE_58", "Light_Filtering_70pct_Bouvardia_Cream_64", "Light_Filtering_70pct_Bouvardia_Dark_Grey_66", "Light_Filtering_70pct_Bouvardia_Medium_Grey_65", "Light_Filtering_70pct_ESSENTIAL_CREAM-68", "Light_Filtering_70pct_ESSENTIAL_GREY-69", "Light_Filtering_70pct_ESSENTIALWHITE_55", "Light_Filtering_70pct_LINEN_CARAM_EL-67", "Light_Filtering_70pct_LINEN_SAND_57", "Light_Filtering_70pct_LINEN_WHITE_36", "Light_Filtering_70pct_SAFAR_IVORY_63", "Light_Filtering_70pct_SAFARI_WHITE_62", "Light_Filtering_70pct_TREEBARK_BLACK-75", "Light_Filtering_70pct_TREEBARK_CREAM-71", "Light_Filtering_70pct_TREEBARK_GREY-73", "Light_Filtering_70pct_TREEBARK_NAVY-72", "Light_Filtering_70pct_TREEBARK_SHALLOW-74", "Light_Filtering_70pct_TREEBARK_WHITE-70"];
const zebraFiles = ["Zebra_60pct_BLACK-34", "Zebra_60pct_GREY-32", "Zebra_60pct_NAVY-33", "Zebra_60pct_WHITE-31", "Zebra_70pct_LINEN-43", "Zebra_85pct_GREY-35", "Zebra_85pct_WAVE_BLACK-37", "Zebra_85pct_WAVE_GREY-36", "Zebra_100pct_BLUE-44", "Zebra_100pct_CHARCOAL-46", "Zebra_100pct_DARK_GREY-41", "Zebra_100pct_MID_GREY-40", "Zebra_100pct_OLIVE-45", "Zebra_100pct_ROCK_BLACK-42", "Zebra_100pct_WHITE_STONE-38", "Zebra_100pct_WHITE-39"];
const cellularFiles = ["Cellular_Blackout_Blue_110", "Cellular_Blackout_Brown_107", "Cellular_Blackout_Grey_109", "Cellular_Blackout_Prestige_Black-118", "Cellular_Blackout_Prestige_Brown-119", "Cellular_Blackout_Prestige_Grey_White-116", "Cellular_Blackout_Prestige_Grey-117", "Cellular_Blackout_Prestige_Linen-120", "Cellular_Blackout_Toffe_108", "Cellular_Blackout_White_106", "Cellular_Light_Filtering_Blue_105", "Cellular_Light_Filtering_Brown_102", "Cellular_Light_Filtering_Grey_104", "Cellular_Light_Filtering_Toffe_103", "Cellular_Light_Filtering_White_101"];
const romanFiles = ["Roman_50pct_Clio_Sand-225", "Roman_50pct_CrossLoom_Grey-223", "Roman_50pct_CrossLoom_Sand-222", "Roman_50pct_CrossLoom_White-221", "Roman_60pct_Clio_Grey-226", "Roman_60pct_Clio_Mixblack-227", "Roman_60pct_Clio_White-224", "Roman_70pct_Essential_Smoky-229", "Roman_70pct_Essential_White-228", "Roman_70pct_Linen_White-234", "Roman_70pct_Safari_Biscuit-233", "Roman_70pct_Safari_Cream-232", "Roman_70pct_Safari_Grey-231", "Roman_70pct_Safari_White-230", "Roman_100pct_Dream_Feather_Grey-241", "Roman_100pct_Dream_Fog_Mist-240", "Roman_100pct_Dream_Grey-242", "Roman_100pct_Dream_White-239", "Roman_100pct_Linen_Stone-219", "Roman_100pct_Linen_White-220", "Roman_100pct_Safari_Biscuit-238", "Roman_100pct_Safari_Cream-237", "Roman_100pct_Safari_Grey-236", "Roman_100pct_Safari_White-235"];
const wovenFiles = ["Woven_50pct_Bareloom_Bamboo_Fiber-326", "Woven_50pct_Bareloom_Flax_Bamboo-332", "Woven_50pct_Bareloom_Flax_Reed-333", "Woven_50pct_Bareloom_Hemp-334", "Woven_50pct_Bareloom_Jute_Flax-321", "Woven_50pct_Bareloom_Jute-322", "Woven_50pct_Bareloom_Knaf-323", "Woven_50pct_Bareloom_Rammus-325", "Woven_50pct_Bareloom_Rammus-327", "Woven_50pct_Bareloom_Rammus-328", "Woven_50pct_Bareloom_Rammus-329", "Woven_50pct_Bareloom_Rammus-330", "Woven_50pct_Bareloom_Rammus-331", "Woven_50pct_Bareloom_Red_Knaf-324"];

const formatName = (f) => f.replace(/_/g, ' ').replace(/pct/g, '%');

// --- [3] æ ¸å¿ƒæ•°æ®åº“ ---
const fabricData = {
    blackout: blackoutFiles.map(file => ({ name: formatName(file.replace('Blackout_', '')), img: `image/fabrics/Blackout/${file}.png` })),
    filtering: filteringFiles.map(file => ({ name: formatName(file.replace('Light_Filtering_', '')), img: `image/fabrics/Light Filtering/${file}.png` })),
    zebra: zebraFiles.map(file => ({ name: formatName(file.replace('Zebra_', '')), img: `image/fabrics/Zebra/${file}.png` })),
    cellular: cellularFiles.map(file => ({ name: formatName(file.replace('Cellular_', '')), img: `image/fabrics/Cellular/${file}.png` })),
    roman: romanFiles.map(file => ({ name: formatName(file.replace('Roman_', '')), img: `image/fabrics/Roman/${file}.png` })),
    woven: wovenFiles.map(file => ({ name: formatName(file.replace('Woven_', '')), img: `image/fabrics/Woven/${file}.png` }))
};

const categoryData = {
    blackout: {
        valances: [
            { name: "White Square Valance", img: "image/With Square Valance-White.png" },
            { name: "Black Square Valance", img: "image/With Square Valance-Black.png" },
            { name: "Tonal Valance Fabric Insert", img: "image/Tonal Valance With Fabric Inserts.png" }
        ],
        rods: [
            { name: "Standard Bottom Rod", img: "image/Standard Bottom Rod.png" },
            { name: "Fabric Wrapped Rod", img: "image/Fabric Wrapped Bottom Rod.png" },
            { name: "White Square Rod", img: "image/Square Bottom Rod-White.png" },
            { name: "Black Square Rod", img: "image/Square Bottom Rod-Black.png" }
        ]
    },
    zebra: {
        valances: [
            { name: "fabric_inserts", img: "image/Valance_Rod/Zebra/fabric_inserts.png" },
            { name: "Valance-Black", img: "image/Valance_Rod/Zebra/Valance-Black.png" },
            { name: "Valance-white", img: "image/Valance_Rod/Zebra/Valance-white.png" }
        ],
        rods: [
            { name: "Rod-White", img: "image/Valance_Rod/Zebra/Rod-White.png" },
            { name: "Rod-Black", img: "image/Valance_Rod/Zebra/Rod-Black.png" }
        ]
    },
    filtering: {
        valances: [
            { name: "White Square Valance", img: "image/With Square Valance-White.png" },
            { name: "Black Square Valance", img: "image/With Square Valance-Black.png" }
        ],
        rods: [
            { name: "Standard Bottom Rod", img: "image/Standard Bottom Rod.png" },
            { name: "Fabric Wrapped Rod", img: "image/Fabric Wrapped Bottom Rod.png" },
            { name: "White Square Rod", img: "image/Square Bottom Rod-White.png" },
            { name: "Black Square Rod", img: "image/Square Bottom Rod-Black.png" }
        ]
    },
    roman: {
        valances: [{ name: "Square Valance with Fabric", img: "image/Valance_Rod/Roman/Square_Valance_With_Fabric.png" }],
        rods: [{ name: "Square Bottom Rod with Fabric", img: "image/Valance_Rod/Roman/Square_Bottom_Rod_With_Fabric.png" }]
    },
    cellular: {
        valances: [
            { name: "Valance-Black", img: "image/Valance_Rod/Cellular/Cellular_Valance-Black.png" },
            { name: "Valance-white", img: "image/Valance_Rod/Cellular/Cellular_Valance-White.png" }
        ],
        rods: [
            { name: "Rod-Black", img: "image/Valance_Rod/Cellular/Cellular_Bottom_Rod-Black.png" },
            { name: "Rod-White", img: "image/Valance_Rod/Cellular/Cellular_Bottom_Rod-White.png" }
        ]
    },
    woven: { valances: [], rods: [] }
};

// --- [4] æ¸²æŸ“å‡½æ•° ---
function updateFabricList() {
    const categoryInput = document.querySelector('input[name="Fabric_Category"]:checked');
    if (!categoryInput) return;
    const category = categoryInput.value;

    const fGrid = document.getElementById('fabricGrid');
    const fSection = document.getElementById('fabricDetailSection');
    
    if (fGrid && fSection) {
        fGrid.innerHTML = '';
        const list = fabricData[category] || [];
        if (list.length > 0) {
            fSection.style.display = 'block';
            fGrid.innerHTML = list.map(item => {
                const isChecked = globalSelectedFabrics.has(item.name) ? 'checked' : '';
                return `
                    <label class="grid-item">
                        <input type="checkbox" value="${item.name}" data-cat="${category}" ${isChecked} onchange="toggleFabricSelection(this)">
                        <div class="item-ui"></div>
                        <img src="${item.img}" onclick="zoomImg(event, this.src)" onerror="this.src='https://placehold.co/150x150?text=No+Img'">
                        <span>${item.name}</span>
                    </label>`;
            }).join('');
        } else {
            fSection.style.display = 'none';
        }
    }

    const accData = categoryData[category] || { valances: [], rods: [] };
    renderAccessoryGrid('valanceGrid', accData.valances, 'Valance_Option', category);
    renderAccessoryGrid('rodGrid', accData.rods, 'Rod_Option', category);

    updateStatusBadge();
    updateAccessoryStatus();
    renderSummary();
}

function renderAccessoryGrid(gridId, data, name, category) {
    const grid = document.getElementById(gridId);
    if (!grid) return;
    const group = grid.closest('.group');
    if (data && data.length > 0) {
        if (group) group.style.display = 'block';
        const savedValue = (selectionsMemory[category] || {})[name];
        grid.innerHTML = data.map(item => `
            <label class="grid-item">
                <input type="radio" name="${name}" value="${item.name}" 
                ${savedValue === item.name ? 'checked' : ''} 
                onchange="saveAccessoryChoice('${category}', this.name, this.value)">
                <div class="item-ui"></div>
                <img src="${item.img}" onclick="zoomImg(event, this.src)">
                <span>${item.name}</span>
            </label>`).join('');
    } else {
        if (group) group.style.display = 'none';
        grid.innerHTML = '';
    }
}

// --- [5] é€»è¾‘å¤„ç†å‡½æ•° ---
function saveAccessoryChoice(category, name, value) {
    if (!selectionsMemory[category]) selectionsMemory[category] = {};
    selectionsMemory[category][name] = value;
    updateAccessoryStatus();
}

function toggleFabricSelection(el) {
    const cat = el.getAttribute('data-cat');
    if (el.checked) {
        globalSelectedFabrics.set(el.value, cat);
    } else {
        globalSelectedFabrics.delete(el.value);
    }
    renderSummary();
    updateStatusBadge();
    updateAccessoryStatus();
}

function updateAccessoryStatus() {
    const categoryInput = document.querySelector('input[name="Fabric_Category"]:checked');
    if (!categoryInput) return;
    const currentCat = categoryInput.value;
    const hasCurrentCatFabric = Array.from(globalSelectedFabrics.values()).includes(currentCat);

    const configs = [
        { name: 'Valance_Option', badgeId: 'valanceStatus', gridId: 'valanceGrid' },
        { name: 'Rod_Option', badgeId: 'rodStatus', gridId: 'rodGrid' }
    ];

    configs.forEach(c => {
        const grid = document.getElementById(c.gridId);
        const group = grid ? grid.closest('.group') : null;
        const isVisible = group && group.style.display !== 'none';
        const isSelected = (selectionsMemory[currentCat] || {})[c.name];
        const badge = document.getElementById(c.badgeId);

        if (badge) {
            if (!isVisible) {
                badge.innerText = "N/A"; badge.className = "status-badge status-ok";
            } else if (!hasCurrentCatFabric) {
                badge.innerText = "Optional"; badge.className = "status-badge status-ok";
            } else if (isSelected) {
                badge.innerText = "Ready / å·²é€‰"; badge.className = "status-badge status-ok";
            } else {
                badge.innerText = "Required / å¿…å¡«"; badge.className = "status-badge status-required";
            }
        }
    });
}

function updateStatusBadge() {
    const badge = document.getElementById('fabricStatus');
    if (!badge) return;
    const hasSelection = globalSelectedFabrics.size > 0;
    badge.innerText = hasSelection ? "Ready / å·²é€‰" : "Required / å¿…å¡«";
    badge.className = "status-badge " + (hasSelection ? "status-ok" : "status-required");
}

function renderSummary() {
    const summaryDiv = document.getElementById('selectedSummary');
    const persistentBox = document.getElementById('persistentSummary');
    if (!summaryDiv || !persistentBox) return;
    const names = Array.from(globalSelectedFabrics.keys());
    if (names.length > 0) {
        summaryDiv.innerHTML = names.map(n => `<span class="summary-tag" style="display:inline-block; background:#1a1a1a; color:white; padding:2px 8px; border-radius:15px; margin:2px; font-size:11px;">${n}</span>`).join('');
        persistentBox.style.display = 'block';
    } else {
        summaryDiv.innerHTML = 'Selected: (None)';
        persistentBox.style.display = 'none';
    }
}

// --- [6] è¡¨å•æäº¤ä¸å¯¹åº”å…³ç³»å¯¼å‡º ---
function validateForm() {
    if (globalSelectedFabrics.size === 0) {
        alert("Please select at least one Fabric Style!");
        return false;
    }

    const activeCategories = new Set(globalSelectedFabrics.values());
    let detailedOrder = ""; 

    for (let cat of activeCategories) {
        const data = categoryData[cat];
        if (!data) continue;
        const mem = selectionsMemory[cat] || {};
        const fabricsInCat = Array.from(globalSelectedFabrics.entries())
                                  .filter(pair => pair[1] === cat)
                                  .map(pair => pair[0]);

        if (data.valances.length > 0 && !mem.Valance_Option) {
            alert(`Please choose Valance for ${cat}!`);
            document.querySelector(`input[value="${cat}"]`).click();
            return false;
        }
        if (data.rods.length > 0 && !mem.Rod_Option) {
            alert(`Please choose Bottom Rod for ${cat}!`);
            document.querySelector(`input[value="${cat}"]`).click();
            return false;
        }

        detailedOrder += `\n[Series: ${cat.toUpperCase()}]\nFabrics: ${fabricsInCat.join(', ')}\nValance: ${mem.Valance_Option || 'N/A'}\nRod: ${mem.Rod_Option || 'N/A'}\n--------------------------\n`;
    }

    // æ£€æŸ¥ Accessories è”åŠ¨
    const accessories = Array.from(document.querySelectorAll('input[name="Accessories"]:checked')).map(i => i.value);
    if (accessories.includes('Charger Block') && !accessories.some(v => v.includes('Cable'))) {
        alert("Please also pick a Magnetic Cable for your Charger Block!");
        return false;
    }

    injectHiddenInput('Final_Detailed_Order', detailedOrder);
    injectHiddenInput('Selected_Fabrics_All', Array.from(globalSelectedFabrics.keys()).join(', '));
    return true; 
}

function injectHiddenInput(name, value) {
    let input = document.getElementById('hidden_' + name);
    if (!input) {
        input = document.createElement('input');
        input.type = 'hidden';
        input.id = 'hidden_' + name;
        input.name = name;
        document.querySelector('form').appendChild(input);
    }
    input.value = value;
}

// --- [7] è¾…åŠ©åŠŸèƒ½ (æ”¾å¤§é•œ & åˆå§‹åŒ–) ---
function zoomImg() {
    let src = (arguments.length === 1) ? arguments[0] : arguments[1];
    let e = (arguments.length >= 2) ? arguments[0] : null;
    if (e && e.stopPropagation) e.stopPropagation();

    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    if (modal && modalImg && src) {
        modalImg.src = src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; 
    }
}

window.onload = function() {
    updateFabricList();
    const modal = document.getElementById('modal');
    if (modal) {
        modal.onclick = function() {
            this.style.display = 'none';
            document.body.style.overflow = 'auto';
        };
    }
    document.querySelectorAll('img[onclick^="zoomImg"]').forEach(img => img.style.cursor = 'zoom-in');
};

function clearFabrics() {
    // 1. å½»åº•æ¸…ç©º JS å†…å­˜ä¸­çš„æ•°æ®
    globalSelectedFabrics.clear(); // æ¸…ç©ºå·²é€‰é¢æ–™ Map
    selectionsMemory = {};        // é‡ç½®é…ä»¶é€‰æ‹©è®°å¿†

    // 2. é‡ç½®è¡¨å•åŸç”ŸçŠ¶æ€ (Checkbox å’Œ Radio)
    const form = document.querySelector('form');
    if (form) form.reset();

    // 3. æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨æ¸…ç©ºæ‰€æœ‰éšè—çš„/ä¸åœ¨å½“å‰é¡µé¢çš„ Checkbox çŠ¶æ€
    // å› ä¸º reset() æœ‰æ—¶æ— æ³•è§¦åŠåŠ¨æ€ç”Ÿæˆçš„å…ƒç´ 
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[type="radio"]').forEach(rd => rd.checked = false);

    // 4. æ¢å¤é»˜è®¤çš„å¤§ç±»é€‰ä¸­ï¼ˆå¯é€‰ï¼Œå»ºè®®é€‰ä¸­ç¬¬ä¸€ä¸ªä»¥ä¿æŒç•Œé¢å®Œæ•´ï¼‰
    const firstCategory = document.querySelector('input[name="Fabric_Category"]');
    if (firstCategory) {
        firstCategory.checked = true;
        // é‡æ–°è§¦å‘åˆ—è¡¨æ¸²æŸ“ï¼Œè¿™æ ·é¢æ–™åˆ—è¡¨é‡Œçš„å‹¾é€‰æ¡†æ‰ä¼šè§†è§‰ä¸Šæ¶ˆå¤±
        updateFabricList(); 
    } else {
        // å¦‚æœæ²¡æ‰¾åˆ°åˆ†ç±»ï¼Œå°±æ¸…ç©ºé¢æ–™æ˜¾ç¤ºåŒºåŸŸ
        const fGrid = document.getElementById('fabricGrid');
        if (fGrid) fGrid.innerHTML = '';
    }

    // 5. åˆ·æ–°æ‰€æœ‰çš„çŠ¶æ€æ ‡ç­¾ï¼ˆBadgeï¼‰å’Œåº•éƒ¨çš„æ±‡æ€»æ ï¼ˆSummaryï¼‰
    updateStatusBadge();
    updateAccessoryStatus();
    renderSummary();

    // 6. é¢å¤–å¤„ç†ï¼šç¡®ä¿éšè—åŸŸä¹Ÿè¢«æ¸…ç©º
    const hiddenFab = document.getElementById('hidden_final_fabrics');
    const hiddenOrder = document.getElementById('hidden_Final_Detailed_Order');
    if (hiddenFab) hiddenFab.value = "";
    if (hiddenOrder) hiddenOrder.value = "";

    console.log("Form and memory cleared successfully.");
}
</script>
</html>
